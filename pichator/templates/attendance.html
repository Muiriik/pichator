{% extends 'base.html' %}

{% block title %}Docházka{% endblock %}
{%- set active_page = 'attendance' %}

{% block content %}

{% block scripts %}
<script>
    var pvs = [];

    function submit_data() {
        i = 0
        if ($('#pvs')[0].length != 1) {
            i = $('#pvs')[0].selectedIndex;
        }
        $.get('/attendance_submit?' + $.param({
            'period': $('#period').val(),
            'start': $('#editForm-start').val(),
            'end': $('#editForm-end').val(),
            'mode': $('#editForm-mode').val(),
            'day': $('#editForm-day').val(),
            'pvid': pvs[i].PV
        })).done(function () {
            reload_table();
            $('#modalEditForm').modal('hide');
        });
    }

    $(document).ready(function () {
        {% if not readonly %}
        $('#attendance tbody tr').on('click', function () {
            const data = $(this).data()
            $('#editForm-day').val(data.day);
            $('#editForm-start').val(data.arrival);
            $('#editForm-end').val(data.departure);
            $('#editForm-mode').val(data.mode);
            $('#editForm-weekday').val(data.weekday);
            $('#modalEditForm').modal('show');
        })
        {% endif %}

        $('#period').datepicker({
            viewMode: 'months',
            format: 'mm-yyyy',
            minViewMode: 'months',
            todayHighlight: false,
            todayBtn: 'linked',
            language: 'cs',
        })

        $('#period').datepicker('setDate', '{{ month }}-{{ year }}');

        $("#period").datepicker().on('changeDate', function (e) {
            const date = e.format().split('-')
            const url = '/' + parseInt(date[1]) + '/' + parseInt(date[0]) + '/{{ pvid }}';
            window.location.href = url
        });

        $('.clock-picker').clockpicker();
        $('#editForm-mode').selectpicker();
    });
</script>
{% endblock %}
<div class='container-fluid'>
    <div class="row pichator-toolbar toolbar-pf">
        <div class="col-sm-12">
            <div class="row toolbar-pf-results">
                <div class="col-sm-12">
                    <h5>Období</h5>
                    <p>
                        <a id="period" data-value="{{ month }}-{{ year }}">{{month|month_name}} {{ year }}</a>
                    </p>

                    <h5>PV</h5>
                    <ul class="list-inline">
                        {% for pv in pvs %}
                        <li>
                            {% if pv.pvid == pvid %}
                                {{ pv.department|unit_type }}
                            {% else %}
                            <a href="{{ url_for('index', year=year, month=month, pvid=pv.pvid) }}">
                                {{ pv.department|unit_type }}
                            </a>
                            {% endif %}
                        </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="modalEditForm" tabindex="-1" role="dialog" aria-labelledby="Editace docházky"
        aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header text-center">
                    <h4 class="modal-title w-100 font-weight-bold">Editace docházky</h4>
                </div>
                <div class="modal-body">
                    <form id='updateForm'>
                        <div class="form-group">
                            <label for="editForm-day">Den v měsíci</label>
                            <input type="text" id="editForm-day" class="form-control" disabled>
                        </div>

                        <div class="form-group">
                            <label for="editForm-start">Příchod</label>
                            <input type="time" id="editForm-start" class="form-control clock-picker"
                                data-placement='right' data-align='top' data-autoclose='true'>
                        </div>
                        <div class="form-group">
                            <label for="editForm-end">Odchod</label>
                            <input type="time" id="editForm-end" class="form-control clock-picker"
                                data-placement='right' data-align='top' data-autoclose='true'>
                        </div>
                        <div class="form-group">
                            <label for="editForm-mode">Režim docházky</label>
                            <select id="editForm-mode" class="form-control">
                                <option>Absence</option>
                                <option>Presence</option>
                                <option>Překážka na straně zaměstnavatele</option>
                                <option>Dovolená</option>
                                <option>Dovolená 0.5 dne</option>
                                <option>Pracovní pohotovost</option>
                                <option>Nemoc</option>
                                <option>Náhradní volno</option>
                                <option>Ošetřování člena rodiny</option>
                                <option>Osobní překážky</option>
                                <option>Služební cesta</option>
                                <option>Studium při zaměstnání</option>
                                <option>Školení</option>
                                <option>Úraz/nemoc z povolání</option>
                                <option>Neplacené volno</option>
                                <option>Obecný zájem</option>
                                <option>Zdravotní volno</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="editForm-start">Den v týdnu</label>
                            <input type="text" id="editForm-weekday" class="form-control" disabled>
                        </div>
                    </form>
                </div>
                <div class="modal-footer d-flex justify-content-center">
                    <button class="btn btn-success" onclick='submit_data();'>Uložit</button>
                    <button class="btn btn-warning" data-dismiss='modal'>Zrušit</button>
                </div>
            </div>
        </div>
    </div>
    <div class="row buffer-top-md">
        <div class="col-md-6 col-md-push-3">
            <table class='table-hover table-striped table table-bordered table-responsive' id='attendance'
                name='attendance'>
                <thead>
                    <tr>
                        <th>Den v měsíci</th>
                        <th>Příchod</th>
                        <th>Odchod</th>
                        <th>Režim docházky</th>
                        <th>Pracovní doba</th>
                    </tr>
                </thead>
                <tbody>
                <tbody>
                    {% for index, day in attendance.items() %}
                    <tr class="{{ attendance_class(day) }}" data-date="" data-arrival="{{ day.arrival|short_time }}"
                        data-departure="{{ day.departure|short_time }}" data-mode="{{ day.mode }}"
                        data-weekday="{{ day.date.weekday()|day_name }}" data-day="{{ day.day }}">
                        <td>{{ day.day }}. {{ day.date.weekday()|day_name }}</td>

                        {% if day.timetable %}
                        <td>{{ day.arrival|short_time }}</td>
                        <td>{{ day.departure|short_time }}</td>
                        <td>{{ day.mode }}</td>
                        <td>{{ day.timetable.lower|short_time }} - {{ day.timetable.upper|short_time }}</td>
                        {% else %}
                        <td>-</td>
                        <td>-</td>
                        <td>-</td>
                        <td>-</td>
                        {% endif %}
                    </tr>
                    {% endfor %}
                </tbody>
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}