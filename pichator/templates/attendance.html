{% extends 'base.html' %}

{% block title %}Docházka{% endblock %}

{% block content %}

{% block scripts %}
<script>
    var pvs = [];

    function refresh_dept() {
        i = 0
        if ($('#pvs')[0].length != 1) {
            i = $('#pvs')[0].selectedIndex;
        }
        $('#dept')[0].value = pvs[i].dept;
    }

    $(document).ready(function () {
        $('#period').datepicker({
            viewMode: 'months',
            format: 'mm-yyyy',
            minViewMode: 'months',
        });
        $("#period").datepicker().on('changeDate', function (e) {
            $.get('/pvs?' + $.param({
                    period: $("#period").val()
                }))
                .done(function (data) {
                    $('#pvs').empty();
                    pvs = data.data
                    for (i = 0; i < pvs.length; i++) {
                        $('#pvs').append('<option value = ' + pvs[i].PV + '>' + pvs[i].PV +
                            '</option>')
                    }
                    refresh_dept();
                    $('#pvs').selectpicker('refresh');
                    i = 0
                    if ($('#pvs')[0].length != 1) {
                        i = $('#pvs')[0].selectedIndex;
                    }
                    $('#attendance').DataTable({
                        ajax: {
                            'url': '/attendance_data',
                            'data': {
                                'pvid': pvs[i].PV,
                                'period': $('#period').val()
                            }
                        },
                        columns: [{
                                data: 'day',
                            },
                            {
                                data: 'start',
                            },
                            {
                                data: 'end',
                            },
                            {
                                data: 'mode',
                            },
                            {
                                data: 'weekday',
                            },
                            {
                                data: 'timetable',
                            },
                            {
                                data: 'stamp',
                            },
                        ],
                        order: [
                            [0, "asc"]
                        ],
                        'createdRow': function (row, data, dataIndex) {
                            if (data.weekday == 'Sobota' || data.weekday ==
                                'Neděle') {} else if (data.mode == 'Absence') {
                                $(row).addClass('warning');
                            } else {
                                $(row).addClass('success');
                            }


                        },
                        paging: false,
                        searching: false,
                        bLengthChange: false,
                        bInfo: false,
                        ordering: false,
                        responsive: true,
                    });
                });
        });
        $('#period').datepicker('setDate', new Date());
        $("#pvs").selectpicker();
        $("#pvs").selectpicker().on('change', function (e) {
            refresh_dept();
        });
    });
</script>
{% endblock %}
<div class='container-fluid'>
    <div class='row buffer-top-md well'>
        <form class='form-inline' id='attendance-form' method='post'>
            <div class='form-group'>
                <label for='period'>Období:</label>
                <input class='form-control' name='period' id="period" type='text'>
            </div>
            <div class='form-group'>
                <label for='pvs'>PV:</label>
                <select class='form-control' name='pvs' id="pvs"></select>
            </div>
            <div class='form-group'>
                <label for=''>Oddělení:</label>
                <input class='form-control' id='dept' name='dept' type='text' readonly>
            </div>
        </form>
        <div class='form-group'>
            <button class='btn btn-success'>Uložit</button>
            <button class='btn btn-warning' onclick='redirect("/");'>Zrušit</button>
        </div>
    </div>
    <table class='display table table-bordered table-responsive' id='attendance' name='attendance'>
        <thead>
            <tr>
                <th>Den v měsíci</th>
                <th>Příchod</th>
                <th>Odchod</th>
                <th>Režim docházky</th>
                <th>Den v týdnu</th>
                <th>Precovní doba</th>
                <th>Nárok na stravenku</th>
            </tr>
        </thead>
        <tbody>
        </tbody>
    </table>
</div>
{% endblock %}