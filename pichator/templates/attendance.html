{% extends 'base.html' %}

{% block title %}Docházka{% endblock %}

{% block content %}

{% block scripts %}
<script>
    var pvs = [];

    function crate_select(id, color, options) {
        options_str = '';
        for (i = 0; i < options.length; i++) {
            options_str += '<option value="' + options[i] + '">' + options[i] + '</option>'
        }
        return '<select id="' + id + '" class="' + color + '">' + options_str + '</select>'
    }

    function create_input(id, value, readonly, color) {
        element_text = '<input class="form-control ' + color + '" value="' + value + '" id="' + id + '"' +
            readonly + ' name="' + id + '">'
        return element_text;
    }

    function refresh_dept() {
        i = 0
        if ($('#pvs')[0].length != 1) {
            i = $('#pvs')[0].selectedIndex;
        }
        $('#dept')[0].value = pvs[i].dept;
    }

    function get_att_data() {
        i = 0
        if ($('#pvs')[0].length != 1) {
            i = $('#pvs')[0].selectedIndex;
        }
        $.ajax({
            url: '/attendance_data',
            headers: {
                'X-pvid': pvs[i].PV,
                'X-period': $("#period").val()
            }
        }).done(function (data) {
            var rows = data.data
            $('#attendance').empty();
            stamp = 'Ne';
            readonly = '';
            color = 'input-succ';
            if (rows[0].stamp && rows[0].satmp != 'False') {
                stamp = 'Ano';
            };
            if (rows[0].weekday == 'Sobota' || rows[0].weekday == 'Neděle') {
                readonly = 'disabled';
                rows[0].start = '00:00';
                rows[0].end = '00:00';
                rows[0].mode = 'Mimo ev.';
                color = 'input-info';
            };
            if (rows[0].mode == 'Absence' && color != 'bg-secondary') {
                color = 'input-warn';
            }
            $('#attendance').append(
                '<div class="row">' +
                '<div class="form-group col-xs-1">' +
                '<label for="day1">Den v měsíci</label>' +
                create_input('day1', rows[0].day, 'disabled', color) +
                '</div>' +
                '<div class="form-group col-xs-1">' +
                '<label for="start1"> Příchod</label>' +
                create_input('start1', rows[0].start, readonly, color) +
                '</div>' +
                '<div class="form-group col-xs-1">' +
                '<label for="end1">Odchod</label>' +
                create_input('end1', rows[0].end, readonly, color) +
                '</div>' +
                '<div class="form-group col-xs-1">' +
                '<label for="mode1">Docházka</label>' +
                create_input('mode1', rows[0].mode, readonly, color) +
                '</div>' +
                '<div class="form-group col-xs-1">' +
                '<label for="weekday1">Den v týdnu</label>' +
                create_input('weekday1', rows[0].weekday, 'disabled', color) +
                '</div>' +
                '<div class="form-group col-xs-1">' +
                '<label for="timetable1">Pracovní doba</label>' +
                create_input('timetable1', rows[0].timetable, 'disabled', color) +
                '</div>' +
                '<div class="form-group col-xs-1">' +
                '<label for="stamp1">Stravenka</label>' +
                create_input('stamp1', stamp, 'disabled', color) +
                '</div>' +
                '</div>'
            );
            for (i = 1; i < rows.length; i++) {
                stamp = 'Ne';
                readonly = '';
                color = 'input-succ';
                if (rows[i].stamp && rows[i].satmp != 'False') {
                    stamp = 'Ano';
                };
                if (rows[i].weekday == 'Sobota' || rows[i].weekday == 'Neděle') {
                    readonly = 'disabled';
                    rows[i].start = '00:00';
                    rows[i].end = '00:00';
                    rows[i].mode = 'Mimo ev.';
                    color = 'input-info';
                };
                if (rows[i].mode == 'Absence') {
                    color = 'input-warn';
                }
                $('#attendance').append(
                    '<div class="row">' +
                    '<div class="col-xs-1">' +
                    create_input('day' + (i + 1), rows[i].day, 'disabled', color) +
                    '</div>' +
                    '<div class="col-xs-1">' +
                    create_input('start' + (i + 1), rows[i].start, readonly, color) +
                    '</div>' +
                    '<div class="col-xs-1">' +
                    create_input('end' + (i + 1), rows[i].end, readonly, color) +
                    '</div>' +
                    '<div class="col-xs-1">' +
                    create_input('mode' + (i + 1), rows[i].mode, readonly, color) +
                    '</div>' +
                    '<div class="col-xs-1">' +
                    create_input('weekday' + (i + 1), rows[i].weekday, 'disabled', color) +
                    '</div>' +
                    '<div class="col-xs-1">' +
                    create_input('timetable' + (i + 1), rows[i].timetable, 'disabled', color) +
                    '</div>' +
                    '<div class="col-xs-1">' +
                    create_input('stamp' + (i + 1), stamp, 'disabled', color) +
                    '</div>' +
                    '</div>')
            }
        });
    }

    $(document).ready(function () {
        $('#period').datepicker({
            viewMode: 'months',
            format: 'mm-yyyy',
            minViewMode: 'months',
        });
        $("#period").datepicker().on('changeDate', function (e) {
            $.ajax({
                url: '/pvs',
                headers: {
                    'X-period': $("#period").val()
                }
            }).done(function (data) {
                $('#pvs').empty();
                pvs = data.data
                for (i = 0; i < pvs.length; i++) {
                    $('#pvs').append('<option value = ' + pvs[i].PV + '>' + pvs[i].PV +
                        '</option>')
                }
                refresh_dept();
                $('#pvs').selectpicker('refresh');
                get_att_data();
            });
        });
        $('#period').datepicker('setDate', new Date());
        $("#pvs").selectpicker();
        $("#pvs").selectpicker().on('change', function (e) {
            refresh_dept();
            get_att_data();
        });
    });
</script>
{% endblock %}
<div class='container-fluid'>
    <div class='row buffer-top-md well'>
        <form class='form-inline' id='attendance-form' method='post'>
            <div class='form-group'>
                <label for='period'>Období:</label>
                <input class='form-control' name='period' id="period" type='text'>
            </div>
            <div class='form-group'>
                <label for='pvs'>PV:</label>
                <select class='form-control' name='pvs' id="pvs"></select>
            </div>
            <div class='form-group'>
                <label for=''>Oddělení:</label>
                <input class='form-control' id='dept' name='dept' type='text' readonly>
            </div>
            <div class='form-group'>
                <button class='btn btn-success' form='attendance-from' type='submit'>Uložit</button>
                <button class='btn btn-warning' form='attendance-from' onclick='redirect("/");'>Zrušit</button>
            </div>
        </form>
    </div>

    <div class='row buffer-top-md'>
        <form class='form-inline' id='attendance' name='attendance'>
        </form>
    </div>
</div>
{% endblock %}