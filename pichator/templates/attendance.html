{% extends 'base.html' %}

{% block title %}Docházka{% endblock %}

{% block content %}

{% block scripts %}
<script>
    function create_form(days) {
        form = '';
        for (i = 1; i <= days; i++) {
            form += "<input type='time' name='start" + i + "'><input type='time' name='end" + i +
                "'><input type='text' name='mode" + i + "'>";
        }
        return form
    }

    function submit_data() {
        $.ajax({
            url: '/attendance_submit',
            method: 'POST',
        })
    }

    var pvs = [];
    var editor;

    function refresh_dept() {
        i = 0
        if ($('#pvs')[0].length != 1) {
            i = $('#pvs')[0].selectedIndex;
        }
        $('#dept')[0].value = pvs[i].dept;
    }

    $(document).ready(function () {
        $('#period').datepicker({
            viewMode: 'months',
            format: 'mm-yyyy',
            minViewMode: 'months',
        });
        $("#period").datepicker().on('changeDate', function (e) {
            $.get('/pvs?' + $.param({
                    period: $("#period").val()
                }))
                .done(function (data) {
                    $('#pvs').empty();
                    pvs = data.data
                    for (i = 0; i < pvs.length; i++) {
                        $('#pvs').append('<option value = ' + pvs[i].PV + '>' + pvs[i].PV +
                            '</option>')
                    }
                    refresh_dept();
                    $('#pvs').selectpicker('refresh');
                    i = 0
                    if ($('#pvs')[0].length != 1) {
                        i = $('#pvs')[0].selectedIndex;
                    }
                    if ($.fn.DataTable.isDataTable('#attendance')) {
                        $('#attendance').DataTable().destroy();
                    }
                    $('#attendance tbody').empty();
                    $('#transporter-form').empty();

                    attendance = $('#attendance').DataTable({
                        columns: [{
                                data: 'day',
                            },
                            {
                                data: 'start',
                            },
                            {
                                data: 'end',
                            },
                            {
                                data: 'mode',
                            },
                            {
                                data: 'weekday',
                            },
                            {
                                data: 'timetable',
                            },
                            {
                                data: 'stamp',
                            },
                        ],
                        order: [
                            [0, "asc"]
                        ],
                        createdRow: function (row, data, dataIndex) {
                            if (data.mode == 'Absence' && data.weekday !=
                                'Sobota' &&
                                data.weekday !=
                                'Neděle') {
                                $(row).addClass('warning');
                            } else if (data.mode == 'Presence') {
                                $(row).addClass('success');
                            }
                        },
                        ajax: {
                            'url': '/attendance_data',
                            'data': function (d) {
                                d.pvid = pvs[i].PV;
                                d.period = $('#period').val();

                            },
                        },
                        initComplete: function (settings, data) {
                            $('#transporter-form').append(create_form(data.data
                                .length));
                        },
                        paging: false,
                        searching: false,
                        bLengthChange: false,
                        bInfo: false,
                        ordering: false,
                    });
                });
        });
        $('#period').datepicker('setDate', new Date());
        $("#pvs").selectpicker();
        $("#pvs")
            .selectpicker().on('change', function (e) {
                refresh_dept();
                if ($.fn.DataTable.isDataTable('#attendance')) {
                    $('#attendance').DataTable().destroy();
                }
                $('#attendance tbody').empty();
                $('#transporter-form').empty();

                attendance = $('#attendance').DataTable({
                    columns: [{
                            data: 'day',
                        },
                        {
                            data: 'start',
                        },
                        {
                            data: 'end',
                        },
                        {
                            data: 'mode',
                        },
                        {
                            data: 'weekday',
                        },
                        {
                            data: 'timetable',
                        },
                        {
                            data: 'stamp',
                        },
                    ],
                    order: [
                        [0, "asc"]
                    ],
                    createdRow: function (row, data, dataIndex) {
                        if (data.weekday == 'Sobota' || data.weekday == 'Neděle') {
                            data.mode = 'Mimo Evidenci';
                        } else if (data.mode == 'Absence') {
                            $(row).addClass('warning');
                        } else if (data.mode == 'Presence') {
                            $(row).addClass('success');
                        }
                    },
                    ajax: {
                        'url': '/attendance_data',
                        'data': function (d) {
                            d.pvid = pvs[i].PV;
                            d.period = $('#period').val();

                        },
                    },
                    initComplete: function (settings, data) {
                        $('#transporter-form').append(create_form(data.data
                            .length));
                    },
                    paging: false,
                    searching: false,
                    bLengthChange: false,
                    bInfo: false,
                    ordering: false,
                });
            });
        $('#attendance tbody').on('click', 'tr', function (e) {
            e.stopPropagation();
            var data = attendance.row(this).data();
            console.log(data);
            $('#editForm-day').val(data.day);
            $('#editForm-start').val(data.start);
            $('#modalEditForm').modal('show');
            //open edit modal that shows data from table and decide what is editable
            //on modal submit send new data with pv and datepicker value and reload datatable
        });
    });
</script>
{% endblock %}
<div class='container-fluid'>
    <div class='row buffer-top-md well'>
        <form class='form-inline' id='attendance-form' method='post'>
            <div class='form-group'>
                <label for='period'>Období:</label>
                <input class='form-control' name='period' id="period" type='text'>
            </div>
            <div class='form-group'>
                <label for='pvs'>PV:</label>
                <select class='form-control' name='pvs' id="pvs"></select>
            </div>
            <div class='form-group'>
                <label for=''>Oddělení:</label>
                <input class='form-control' id='dept' name='dept' type='text' readonly>
            </div>
        </form>
    </div>
    <div class="modal fade" id="modalEditForm" tabindex="-1" role="dialog" aria-labelledby="Editace docházky"
        aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header text-center">
                    <h4 class="modal-title w-100 font-weight-bold">Editace docházky</h4>
                </div>
                <div class="modal-body">
                    <form>
                        <div class="form-group">
                            <input type="text" id="editForm-day" class="form-control" disabled>
                            <label for="editForm-day">Den v měsíci</label>
                        </div>

                        <div class="form-group">
                            <input type="time" id="editForm-start" class="form-control validate">
                            <label data-error="wrong" data-success="right" for="editForm-start">Příchod</label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer d-flex justify-content-center">
                    <button class="btn btn-success">Uložit</button>
                    <button class="btn btn-warning" data-dismiss='modal'>Zrušit</button>
                </div>
            </div>
        </div>
    </div>
    <table class='display table table-bordered table-responsive' id='attendance' name='attendance'>
        <thead>
            <tr>
                <th>Den v měsíci</th>
                <th>Příchod</th>
                <th>Odchod</th>
                <th>Režim docházky</th>
                <th>Den v týdnu</th>
                <th>Pracovní doba</th>
                <th>Nárok na stravenku</th>
            </tr>
        </thead>
        <tbody>
        </tbody>
    </table>
    <!-- invisible form for submiting data from table -->
    <form id='transporter-form' name='transporter-form' style='display:none'>
    </form>
</div>
{% endblock %}